# Data Model: Project Initialization

**Feature**: Project Initialization
**Date**: 2026-01-18
**Status**: Initial schema design (to be expanded in feature-specific specs)

## Overview

This document defines the initial Convex database schema for CreateEconomy platform. The schema is designed to support multi-tenancy (Principle IV) and will be expanded as specific features (authentication, products, orders, etc.) are implemented. This initialization focuses on foundational entities needed for platform operation.

## Design Principles

1. **Multi-Tenancy**: All documents MUST include `tenantId` field for data isolation
2. **Tenant Filtering**: All queries MUST automatically filter by `tenantId` from authentication context
3. **Validation Rules**: All fields MUST have validation rules (v.string(), v.number(), etc.)
4. **Indexes**: Frequently queried fields MUST be indexed for performance
5. **Type Safety**: All fields MUST use strongly-typed validators
6. **Cross-Tenant Protection**: Functions MUST enforce tenant boundaries at the function level

## Convex Schema

### Users Table

Stores user accounts with authentication and profile information.

```typescript
users: v.object({
  _id: v.id("users"),
  tenantId: v.string(),  // Multi-tenancy identifier
  email: v.string(),
  name: v.string(),
  role: v.union(v.literal("customer"), v.literal("seller"), v.literal("admin")),
  avatarUrl: v.optional(v.string()),
  createdAt: v.number(),  // Timestamp
  updatedAt: v.number(),  // Timestamp
  emailVerified: v.optional(v.boolean()),
})
  .index("byEmail", ["tenantId", "email"])
  .index("byTenant", ["tenantId"])
```

**Fields**:
- `_id`: Unique identifier (auto-generated by Convex)
- `tenantId`: Tenant identifier for multi-tenancy (required for all queries)
- `email`: User email address (unique per tenant)
- `name`: User display name
- `role`: User role - determines access level (customer, seller, admin)
- `avatarUrl`: Optional profile picture URL
- `createdAt`: Account creation timestamp
- `updatedAt`: Last update timestamp
- `emailVerified`: Email verification status (optional)

**Indexes**:
- `byEmail`: Lookups by email (for authentication and user lookup)
- `byTenant`: List all users in a tenant

**Validation Rules**:
- Email format will be validated via v.string().email() pattern in application code
- Role must be one of: customer, seller, admin
- Name must be non-empty
- TenantId is required for all operations

**Relationships**:
- One-to-many with Products (if seller role)
- One-to-many with Orders (if customer role)
- One-to-many with ForumPosts (all roles)

---

### Sessions Table

Stores active user sessions for authentication across all four domains.

```typescript
sessions: v.object({
  _id: v.id("sessions"),
  tenantId: v.string(),
  userId: v.id("users"),
  token: v.string(),
  expiresAt: v.number(),  // Timestamp
  createdAt: v.number(),
  lastAccessedAt: v.number(),
})
  .index("byUser", ["tenantId", "userId"])
  .index("byToken", ["token"])
  .index("byExpiry", ["expiresAt"])
```

**Fields**:
- `_id`: Unique identifier
- `tenantId`: Tenant identifier
- `userId`: Reference to user (foreign key)
- `token`: Session token for authentication
- `expiresAt`: Session expiration timestamp
- `createdAt`: Session creation timestamp
- `lastAccessedAt`: Last activity timestamp (for session refresh)

**Indexes**:
- `byUser`: List all sessions for a user
- `byToken`: Lookup session by token (authentication)
- `byExpiry`: Clean up expired sessions

**Validation Rules**:
- Token must be cryptographically secure
- ExpiresAt must be in the future
- UserId must reference valid user

**Relationships**:
- Many-to-one with Users

**Purpose**:
- Implements Principle V: Single Session Authentication across all domains
- Enables seamless cross-domain user experience
- Supports session timeout and logout sync

---

### Tenants Table

Stores tenant information for multi-tenant architecture.

```typescript
tenants: v.object({
  _id: v.id("tenants"),
  name: v.string(),
  slug: v.string(),  // URL-friendly identifier
  domain: v.optional(v.string()),  // Custom domain if applicable
  plan: v.union(v.literal("free"), v.literal("starter"), v.literal("business"), v.literal("enterprise")),
  createdAt: v.number(),
  updatedAt: v.number(),
  settings: v.optional(v.object({
    allowCustomDomain: v.boolean(),
    maxUsers: v.number(),
    maxStorage: v.number(),
  })),
})
  .index("bySlug", ["slug"])
```

**Fields**:
- `_id`: Unique identifier
- `name`: Tenant display name
- `slug`: URL-friendly identifier (e.g., "my-company")
- `domain`: Optional custom domain (e.g., "mycompany.createconomy.com")
- `plan`: Subscription plan (free, starter, business, enterprise)
- `createdAt`: Tenant creation timestamp
- `updatedAt`: Last update timestamp
- `settings`: Tenant-specific settings object

**Indexes**:
- `bySlug`: Lookup tenant by slug (for custom domains)

**Validation Rules**:
- Slug must be URL-safe (alphanumeric, hyphens)
- Domain must be valid if provided
- Plan must be one of: free, starter, business, enterprise
- Settings must be valid object if provided

**Relationships**:
- One-to-many with Users
- One-to-many with Products
- One-to-many with Orders
- One-to-many with ForumPosts

**Purpose**:
- Implements Principle IV: Multi-Tenant Data Isolation
- Enables serving multiple organizations on same platform
- Supports subscription tiers and feature gating

---

### Products Table

Placeholder for product catalog (to be expanded in marketplace features).

```typescript
products: v.object({
  _id: v.id("products"),
  tenantId: v.string(),
  sellerId: v.id("users"),
  name: v.string(),
  description: v.optional(v.string()),
  price: v.number(),  // In cents (e.g., $10.00 = 1000)
  currency: v.string(),  // ISO 4217 code (e.g., "USD")
  status: v.union(v.literal("draft"), v.literal("active"), v.literal("archived")),
  imageUrl: v.optional(v.string()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("bySeller", ["tenantId", "sellerId"])
  .index("byStatus", ["tenantId", "status"])
```

**Fields**:
- `_id`: Unique identifier
- `tenantId`: Tenant identifier
- `sellerId`: Reference to seller user
- `name`: Product name
- `description`: Optional product description
- `price`: Price in smallest currency unit (cents)
- `currency`: Currency code (ISO 4217)
- `status`: Product status (draft, active, archived)
- `imageUrl`: Optional product image URL
- `createdAt`: Creation timestamp
- `updatedAt`: Last update timestamp

**Indexes**:
- `bySeller`: List all products for a seller
- `byStatus`: List products by status (e.g., all active products)

**Validation Rules**:
- Price must be non-negative
- Currency must be valid ISO 4217 code
- SellerId must reference valid user with seller role
- Status must be one of: draft, active, archived

**Relationships**:
- Many-to-one with Tenants
- Many-to-one with Users (seller)
- One-to-many with OrderItems

**Note**: This is a placeholder schema. Full product catalog schema will be defined in marketplace feature specification.

---

### Orders Table

Placeholder for order management (to be expanded in checkout features).

```typescript
orders: v.object({
  _id: v.id("orders"),
  tenantId: v.string(),
  customerId: v.id("users"),
  status: v.union(
    v.literal("pending"),
    v.literal("processing"),
    v.literal("shipped"),
    v.literal("delivered"),
    v.literal("cancelled"),
    v.literal("refunded")
  ),
  total: v.number(),  // In cents
  currency: v.string(),
  shippingAddress: v.optional(v.object({
    name: v.string(),
    address: v.string(),
    city: v.string(),
    state: v.string(),
    zip: v.string(),
    country: v.string(),
  })),
  paymentIntentId: v.optional(v.string()),  // Stripe reference
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("byCustomer", ["tenantId", "customerId"])
  .index("byStatus", ["tenantId", "status"])
```

**Fields**:
- `_id`: Unique identifier
- `tenantId`: Tenant identifier
- `customerId`: Reference to customer user
- `status`: Order status (pending, processing, shipped, delivered, cancelled, refunded)
- `total`: Order total in cents
- `currency`: Currency code
- `shippingAddress`: Optional shipping address object
- `paymentIntentId`: Optional Stripe PaymentIntent ID
- `createdAt`: Order creation timestamp
- `updatedAt`: Last update timestamp

**Indexes**:
- `byCustomer`: List all orders for a customer
- `byStatus`: List orders by status

**Validation Rules**:
- Total must be non-negative
- Currency must be valid ISO 4217 code
- CustomerId must reference valid user with customer role
- Status must be one of defined values
- PaymentIntentId must be valid Stripe ID if provided

**Relationships**:
- Many-to-one with Tenants
- Many-to-one with Users (customer)
- One-to-many with OrderItems

**Note**: This is a placeholder schema. Full order management schema will be defined in checkout feature specification.

---

### ForumPosts Table

Placeholder for forum posts (to be expanded in forum features).

```typescript
forumPosts: v.object({
  _id: v.id("forumPosts"),
  tenantId: v.string(),
  authorId: v.id("users"),
  title: v.string(),
  content: v.string(),
  category: v.optional(v.string()),
  status: v.union(v.literal("draft"), v.literal("published"), v.literal("locked")),
  viewCount: v.number(),
  likeCount: v.number(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("byAuthor", ["tenantId", "authorId"])
  .index("byCategory", ["tenantId", "category"])
  .index("byStatus", ["tenantId", "status"])
```

**Fields**:
- `_id`: Unique identifier
- `tenantId`: Tenant identifier
- `authorId`: Reference to author user
- `title`: Post title
- `content`: Post content (Markdown supported)
- `category`: Optional category
- `status`: Post status (draft, published, locked)
- `viewCount`: View counter
- `likeCount`: Like counter
- `createdAt`: Creation timestamp
- `updatedAt`: Last update timestamp

**Indexes**:
- `byAuthor`: List posts by author
- `byCategory`: List posts by category
- `byStatus`: List posts by status

**Validation Rules**:
- Title must be non-empty
- Content must be non-empty
- AuthorId must reference valid user
- Status must be one of: draft, published, locked
- ViewCount and likeCount must be non-negative

**Relationships**:
- Many-to-one with Tenants
- Many-to-one with Users (author)
- One-to-many with ForumComments

**Note**: This is a placeholder schema. Full forum schema will be defined in forum feature specification.

---

### ForumComments Table

Placeholder for forum comments (to be expanded in forum features).

```typescript
forumComments: v.object({
  _id: v.id("forumComments"),
  tenantId: v.string(),
  postId: v.id("forumPosts"),
  authorId: v.id("users"),
  content: v.string(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("byPost", ["tenantId", "postId"])
  .index("byAuthor", ["tenantId", "authorId"])
```

**Fields**:
- `_id`: Unique identifier
- `tenantId`: Tenant identifier
- `postId`: Reference to forum post
- `authorId`: Reference to author user
- `content`: Comment content
- `createdAt`: Creation timestamp
- `updatedAt`: Last update timestamp

**Indexes**:
- `byPost`: List comments for a post
- `byAuthor`: List comments by author

**Validation Rules**:
- PostId must reference valid forum post
- AuthorId must reference valid user
- Content must be non-empty

**Relationships**:
- Many-to-one with Tenants
- Many-to-one with ForumPosts
- Many-to-one with Users (author)

**Note**: This is a placeholder schema. Full forum comment schema will be defined in forum feature specification.

---

## Schema Relationships Diagram

```
Tenants (1) ────< (N) Users
                    │
                    ├── (N) Products (seller role)
                    │
                    ├── (N) Orders (customer role)
                    │
                    └── (N) ForumPosts

Users (1) ────< (N) Sessions

ForumPosts (1) ────< (N) ForumComments

Orders (1) ────< (N) OrderItems (to be defined)
```

## Multi-Tenancy Implementation

### Tenant Identification

Every document includes `tenantId` field. This field is automatically populated during document creation based on the authenticated user's tenant context.

### Automatic Tenant Filtering

All queries MUST automatically filter by `tenantId`:

```typescript
// Convex function example
export const listProducts = query({
  args: {},

  handler: async (ctx, args) => {
    // Get tenantId from authentication context
    const userId = ctx.auth.getUserId();
    const user = await ctx.db.get(userId);
    const tenantId = user.tenantId;

    // Query only tenant's products
    return await ctx.db
      .query("products")
      .withIndex("byTenant")
      .eq("tenantId", tenantId)
      .collect();
  }
});
```

### Cross-Tenant Protection

Functions MUST enforce tenant boundaries:

```typescript
// Tenant protection example
export const getProduct = query({
  args: { id: v.id("products") },

  handler: async (ctx, args) => {
    const userId = ctx.auth.getUserId();
    const user = await ctx.db.get(userId);
    const product = await ctx.db.get(args.id);

    // Verify product belongs to user's tenant
    if (product.tenantId !== user.tenantId) {
      throw new Error("Unauthorized: Product not found");
    }

    return product;
  }
});
```

## Validation Rules Summary

| Table | Field | Validation |
|-------|--------|------------|
| users | email | Valid email format, non-empty |
| users | role | customer, seller, or admin |
| sessions | token | Cryptographically secure |
| sessions | expiresAt | Future timestamp |
| tenants | slug | URL-safe alphanumeric |
| tenants | plan | free, starter, business, or enterprise |
| products | price | Non-negative number |
| products | currency | Valid ISO 4217 code |
| products | status | draft, active, or archived |
| orders | status | pending, processing, shipped, delivered, cancelled, or refunded |
| orders | total | Non-negative number |
| forumPosts | status | draft, published, or locked |

## Performance Considerations

### Indexing Strategy

- `byTenant`: Indexes on `tenantId` for efficient tenant filtering
- `byEmail`: Index on email for fast user lookup (authentication)
- `byUser`: Index on `userId` for session and order lookup
- `byStatus`: Index on status for filtering products/orders/posts

### Query Optimization

- Always use indexes for filtering by `tenantId`
- Limit query results with `.take(n)` for pagination
- Use `.collect()` only when all results are needed
- Cursor-based pagination for large result sets (to be implemented in specific features)

### Data Cleanup

- Expired sessions are cleaned up via scheduled task (to be implemented)
- Archived products can be moved to separate storage (future optimization)
- Soft delete pattern instead of hard delete for audit trail (to be implemented)

## Security Considerations

### Data Access Control

- All queries MUST filter by `tenantId`
- All mutations MUST verify tenant ownership
- Admins have cross-tenant access (role-based access control to be implemented)
- Audit logging for data access (to be implemented)

### Authentication Required

- All functions require authentication via `ctx.auth.getUserId()`
- Public functions (if any) must be explicitly marked
- Session tokens are validated on every request

### Input Validation

- All inputs are validated via Convex schema validators
- User inputs are validated on client and server
- Email format, currency codes, URLs are validated

## Future Expansions

The following schemas will be defined in feature-specific specifications:

1. **Order Items**: Individual line items in orders (Checkout feature)
2. **Payment Transactions**: Payment history and Stripe integration (Checkout feature)
3. **Categories**: Product and forum categorization (Marketplace/Forum features)
4. **Notifications**: User notification system (Notification feature)
5. **Audit Logs**: Data access and modification logging (Security feature)
6. **File Uploads**: Document and image storage (File Upload feature)
7. **Settings**: User and tenant preferences (Settings feature)

## Notes

- This is an initial schema design for project initialization
- Schemas will be expanded and refined as features are implemented
- Migration strategy will be defined when schema changes are needed
- Data seeding for development will be implemented separately
- Backup and disaster recovery strategy to be defined

---

## References

- [Convex Schema Documentation](https://docs.convex.dev/guides/schemas)
- [Convex Validation Rules](https://docs.convex.dev/api/interfaces/validator)
- [Convex Indexes](https://docs.convex.dev/guides/schemas#indexes)
- [Multi-Tenancy Best Practices](https://docs.convex.dev/guides/production/multi-tenancy)
